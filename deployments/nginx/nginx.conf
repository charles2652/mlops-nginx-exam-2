# ------------------------------------------------------------------
# Nginx configuration pour A/B Testing avec HTTPS + Limite de requêtes
# ------------------------------------------------------------------

events {
    worker_connections 1024;  # Nombre max de connexions par worker
}

http {
    # -------------------------
    # Upstreams pour API
    # -------------------------
    upstream api_v1 {
        server mlops-iris-api:8000;        # version standard
    }

    upstream api_v2 {
        server mlops-iris-api-debug:8000;  # version debug
    }

	# Mappe l'en-tête X-Experiment-Group vers la variable $backend
    map $http_x_experiment_group $backend {
        default api_v1;     # Tout le monde par défaut va vers api_v1
        debug   api_v2;     # Si l'en-tête vaut "debug", alors on prend api_v2
    }

    log_format abtest '$remote_addr [$time_local] '
                 '"$request" $status '
                 'backend=$backend';

    access_log /var/log/nginx/access.log abtest;

    # -------------------------
    # Limitation de requêtes
    # -------------------------
    limit_req_zone $binary_remote_addr zone=apilimit:10m rate=1r/s;

    # -------------------------
    # Serveur HTTP (port 80)
    # -------------------------
    server {
        listen 80;
        server_name localhost;

        # Redirige tout le HTTP vers HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # -------------------------
    # Serveur HTTPS (port 443)
    # -------------------------
    server {
        listen 443 ssl;
        server_name localhost;

        # Certificats SSL
        ssl_certificate /etc/nginx/certs/nginx.crt;
        ssl_certificate_key /etc/nginx/certs/nginx.key;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # -------------------------
        # Location /predict avec A/B Testing
        # -------------------------
        location /predict {

	    # Routage selon l'en-tête X-Experiment-Group via map
	    proxy_pass http://$backend/;

            # Limitation de requêtes
            limit_req zone=apilimit burst=5 nodelay;

            # Authentification basique
            auth_basic "API Access Protected";
            auth_basic_user_file /etc/nginx/.htpasswd;

            # Headers pour le proxy
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # -------------------------
        # Toutes les autres requêtes
        # -------------------------
        location / {
            proxy_pass http://api_v1;  # ou api_v1 par défaut
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
